<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Web Flash Tool</title>
</head>
<body>
    <h1>ESP32 Web Flash Tool</h1>
    
    <div>
        <h2>Flash</h2>
        
        <div>
            <label for="fileInput">Select .bin file:</label>
            <input type="file" id="fileInput" accept=".bin" />
        </div>
        
        <div>
            <label for="addressSelect">Memory Address:</label>
            <select id="addressSelect">
                <option value="0x1000">0x1000 - Bootloader</option>
                <option value="0x8000">0x8000 - Partition Table</option>
                <option value="0x10000">0x10000 - Application</option>
                <option value="0x20000">0x20000 - OTA Data</option>
                <option value="0x30000">0x30000 - NVS</option>
                <option value="0x40000">0x40000 - SPIFFS</option>
                <option value="0x50000">0x50000 - LittleFS</option>
                <option value="custom">Custom Address</option>
            </select>
        </div>
        
        <div id="customAddressDiv" style="display: none;">
            <label for="customAddress">Custom Address (hex):</label>
            <input type="text" id="customAddress" placeholder="0x10000" />
        </div>
        
        <div>
            <label>
                <input type="checkbox" id="autoReset" checked />
                Auto Reset
            </label>
        </div>
        
        <div>
            <button id="connectButton">Connect</button>
            <button id="flashButton" disabled>Flash</button>
        </div>
        
        <div id="status"></div>
    </div>

    <script type="module">
        import { ESPLoader, Transport } from './esptools.js';
        
        let espLoader = null;
        let transport = null;
        
        document.getElementById('addressSelect').addEventListener('change', function() {
            const customDiv = document.getElementById('customAddressDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        });
        
        document.getElementById('connectButton').addEventListener('click', connectESP32);
        document.getElementById('flashButton').addEventListener('click', flashESP32);
        
        async function connectESP32() {
            try {
                console.log('Connecting to ESP32...');
                updateStatus('Connecting to ESP32...');
                
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                console.log('Serial opened');
                
                transport = new Transport(port, true);
                console.log('Transport created:', transport);
                
                espLoader = new ESPLoader(transport);
                console.log('ESPLoader created:', espLoader);
                
                console.log('Connecting...');
                await espLoader.connect();
                
                console.log('Connected to ESP32');
                updateStatus('Connected to ESP32');
                
                document.getElementById('flashButton').disabled = false;
                document.getElementById('connectButton').disabled = true;
                
            } catch (error) {
                console.error('Connection failed:', error);
                updateStatus('Connection failed: ' + error.message);
                
                document.getElementById('flashButton').disabled = true;
                document.getElementById('connectButton').disabled = false;
            }
        }
        
        async function flashESP32() {
            if (!espLoader) {
                updateStatus('No ESP32 connected');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('Select .bin file');
                return;
            }
            
            try {
                console.log('Starting flashing...');
                updateStatus('Starting flashing...');
                
                // Get address
                let address;
                const addressSelect = document.getElementById('addressSelect');
                if (addressSelect.value === 'custom') {
                    const customAddress = document.getElementById('customAddress').value;
                    if (!customAddress) {
                        updateStatus('Please enter custom address');
                        return;
                    }
                    address = parseInt(customAddress, 16);
                } else {
                    address = parseInt(addressSelect.value, 16);
                }
                
                console.log('Flash address:', '0x' + address.toString(16));
                
                // Read file
                const fileBuffer = await file.arrayBuffer();
                const data = new Uint8Array(fileBuffer);
                
                console.log('File size:', data.length, 'bytes');
                
                // flash
                await espLoader.flashData(address, data);
                
                console.log('Flash completed successfully');
                updateStatus('Flash completed successfully');
                
                // if Auto reset enabled
                const autoReset = document.getElementById('autoReset').checked;
                if (autoReset) {
                    console.log('Resetting ESP32...');
                    updateStatus('Resetting ESP32...');
                    
                    // Auto-reset
                    await transport.setDTR(false);  // GPIO0 low?
                    await transport.setRTS(false);  // EN low?
                    await new Promise(resolve => setTimeout(resolve, 200));
                    await transport.setRTS(true);   // EN high?
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await transport.setDTR(true);   // GPIO0 high?
                    
                    updateStatus('ESP32 reset completed');
                }
                
            } catch (error) {
                console.error('Flash failed:', error);
                updateStatus('Flash failed: ' + error.message);
            }
        }
        
        function updateStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            console.log('Status:', message);
        }
        
        if (!navigator.serial) {
            updateStatus('Web Serial API not supported. Please use Chrome/Edge browser.');
        }
    </script>
</body>
</html>
